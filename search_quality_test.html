<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索画质检测测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .result {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: monospace;
        }
        .quality-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px;
        }
        .bg-purple-600 { background-color: #9333ea; color: white; }
        .bg-green-600 { background-color: #16a34a; color: white; }
        .bg-blue-600 { background-color: #2563eb; color: white; }
        .bg-amber-500 { background-color: #f59e0b; color: white; }
        .bg-gray-500 { background-color: #6b7280; color: white; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>搜索画质检测测试</h1>
    
    <button onclick="testSearchFlow()">模拟搜索流程</button>
    <button onclick="testBatchDetection()">批量检测测试</button>
    
    <div id="results"></div>

    <!-- 引入必要的脚本 -->
    <script src="js/config.js"></script>
    <script src="js/simple_quality_detector.js"></script>

    <script>
        // 模拟搜索结果数据
        const mockSearchResults = [
            {
                vod_name: '扫毒风暴2025',
                vod_id: 'test001',
                source_code: 'heimuer',
                source_name: '黑木耳资源',
                vod_play_url: 'https://m3u8.heimuertv.com/play/8956f3d7c69043d59bfb34a1b5879223.m3u8'
            },
            {
                vod_name: '测试视频1080p',
                vod_id: 'test002',
                source_code: 'test',
                source_name: '测试源',
                vod_play_url: 'https://example.com/video_1080p_fullhd.m3u8'
            },
            {
                vod_name: '测试视频720p',
                vod_id: 'test003',
                source_code: 'test',
                source_name: '测试源',
                vod_play_url: 'https://example.com/video_720p_hd.m3u8'
            },
            {
                vod_name: '测试视频4K',
                vod_id: 'test004',
                source_code: 'test',
                source_name: '测试源',
                vod_play_url: 'https://example.com/video_4k_uhd.m3u8'
            }
        ];

        // 模拟搜索流程中的画质检测
        async function testSearchFlow() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">模拟搜索流程中...</div>';
            
            const detectedResults = [];
            
            for (const item of mockSearchResults) {
                try {
                    // 模拟搜索中的URL提取逻辑
                    let firstEpisodeUrl = '';
                    if (item.vod_play_url) {
                        const firstSegment = item.vod_play_url.split('#')[0];
                        firstEpisodeUrl = firstSegment.includes('$') ? firstSegment.split('$')[1] : firstSegment;
                    }
                    
                    // 调用画质检测
                    const checkResult = await window.precheckSource(firstEpisodeUrl);
                    
                    // 合并结果（模拟搜索流程）
                    const finalItem = { ...item, ...checkResult };
                    detectedResults.push(finalItem);
                    
                } catch (error) {
                    detectedResults.push({
                        ...item,
                        quality: '检测失败',
                        loadSpeed: 'N/A',
                        pingTime: -1
                    });
                }
            }
            
            // 渲染结果
            let html = '<h3>搜索流程检测结果:</h3>';
            detectedResults.forEach(item => {
                html += `
                    <div class="result">
                        <strong>${item.vod_name}</strong><br>
                        来源: ${item.source_name}<br>
                        URL: ${item.vod_play_url}<br>
                        检测画质: <span class="quality-badge ${getQualityClass(item.quality)}">${item.quality}</span><br>
                        加载速度: ${item.loadSpeed}<br>
                        延迟: ${item.pingTime}ms
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // 批量检测测试
        async function testBatchDetection() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">批量检测中...</div>';
            
            const testUrls = [
                'https://m3u8.heimuertv.com/play/8956f3d7c69043d59bfb34a1b5879223.m3u8',
                'https://example.com/video_1080p.m3u8',
                'https://example.com/video_720p_hd.m3u8',
                'https://example.com/video_4k_uhd.m3u8',
                'https://example.com/video_480p_sd.m3u8'
            ];
            
            const startTime = performance.now();
            const results = await Promise.all(
                testUrls.map(async (url) => {
                    try {
                        const result = await window.precheckSource(url);
                        return { url, ...result, success: true };
                    } catch (error) {
                        return { url, error: error.message, success: false };
                    }
                })
            );
            const totalTime = performance.now() - startTime;
            
            let html = `<h3>批量检测结果 (总耗时: ${Math.round(totalTime)}ms):</h3>`;
            results.forEach((item, index) => {
                html += `
                    <div class="result">
                        <strong>测试 ${index + 1}:</strong><br>
                        URL: ${item.url}<br>
                        ${item.success ? 
                            `画质: <span class="quality-badge ${getQualityClass(item.quality)}">${item.quality}</span><br>
                             速度: ${item.loadSpeed}<br>
                             延迟: ${item.pingTime}ms` :
                            `错误: ${item.error}`
                        }
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // 获取画质对应的CSS类
        function getQualityClass(quality) {
            switch (quality) {
                case '4K': return 'bg-amber-500';
                case '2K': return 'bg-purple-600';
                case '1080p': return 'bg-purple-600';
                case '720p': return 'bg-blue-600';
                case '480p': return 'bg-green-600';
                case 'SD': return 'bg-gray-500';
                default: return 'bg-gray-500';
            }
        }
        
        // 页面加载后显示状态
        window.addEventListener('load', () => {
            console.log('检测器加载状态:');
            console.log('window.precheckSource:', typeof window.precheckSource);
            console.log('window.comprehensiveQualityCheck:', typeof window.comprehensiveQualityCheck);
        });
    </script>
</body>
</html>