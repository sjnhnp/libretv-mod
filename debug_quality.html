<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画质检测调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .result {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: monospace;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>画质检测调试</h1>
    
    <button onclick="testCurrentDetector()">测试当前检测器</button>
    <button onclick="testSearchFlow()">模拟搜索流程</button>
    
    <div id="results"></div>

    <!-- 引入脚本 - 按照index.html的顺序 -->
    <script src="js/config.js"></script>
    <script src="js/simple_quality_detector.js"></script>
    <script src="js/api.js"></script>

    <script>
        const testUrl = 'https://m3u8.heimuertv.com/play/8956f3d7c69043d59bfb34a1b5879223.m3u8';
        
        async function testCurrentDetector() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">测试中...</div>';
            
            try {
                console.log('当前 window.precheckSource 函数:', window.precheckSource);
                console.log('函数类型:', typeof window.precheckSource);
                
                const result = await window.precheckSource(testUrl);
                console.log('检测结果:', result);
                
                resultsDiv.innerHTML = `
                    <div class="result">
                        <strong>当前检测器测试结果:</strong><br>
                        画质: ${result.quality}<br>
                        加载速度: ${result.loadSpeed}<br>
                        延迟: ${result.pingTime}ms<br><br>
                        <strong>函数信息:</strong><br>
                        函数名: ${window.precheckSource.name}<br>
                        函数类型: ${typeof window.precheckSource}
                    </div>
                `;
            } catch (error) {
                console.error('检测失败:', error);
                resultsDiv.innerHTML = `<div class="result">检测失败: ${error.message}</div>`;
            }
        }
        
        async function testSearchFlow() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">模拟搜索流程...</div>';
            
            // 模拟搜索结果中的一个item
            const mockItem = {
                vod_name: '测试视频',
                vod_id: 'test123',
                source_code: 'test_source',
                vod_play_url: testUrl
            };
            
            try {
                // 模拟搜索中的画质检测逻辑
                let firstEpisodeUrl = '';
                if (mockItem.vod_play_url) {
                    const firstSegment = mockItem.vod_play_url.split('#')[0];
                    firstEpisodeUrl = firstSegment.includes('$') ? firstSegment.split('$')[1] : firstSegment;
                }
                
                console.log('提取的播放URL:', firstEpisodeUrl);
                
                const checkResult = await window.precheckSource(firstEpisodeUrl);
                const finalItem = { ...mockItem, ...checkResult };
                
                console.log('最终item:', finalItem);
                
                resultsDiv.innerHTML = `
                    <div class="result">
                        <strong>搜索流程模拟结果:</strong><br>
                        原始URL: ${mockItem.vod_play_url}<br>
                        提取URL: ${firstEpisodeUrl}<br>
                        检测画质: ${checkResult.quality}<br>
                        最终item.quality: ${finalItem.quality}<br><br>
                        <strong>完整检测结果:</strong><br>
                        ${JSON.stringify(checkResult, null, 2)}
                    </div>
                `;
            } catch (error) {
                console.error('搜索流程测试失败:', error);
                resultsDiv.innerHTML = `<div class="result">搜索流程测试失败: ${error.message}</div>`;
            }
        }
        
        // 页面加载后显示当前状态
        window.addEventListener('load', () => {
            console.log('页面加载完成');
            console.log('window.precheckSource:', window.precheckSource);
            console.log('window.simplePrecheckSource:', window.simplePrecheckSource);
            console.log('window.comprehensiveQualityCheck:', window.comprehensiveQualityCheck);
        });
    </script>
</body>
</html>